<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Content Security Policy (Bug 8) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://text.pollinations.ai; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://text.pollinations.ai; frame-src 'self' blob: data:;">
  
  <!-- SEO Meta Tags -->
  <title>KrizVibe Editor – AI-Powered Code Editor & Web Playground</title>
  <meta name="description" content="KrizVibe Editor is an AI-powered HTML/CSS/JS playground with Monaco editor, local project saving, and KrizVibe AI for instant website generation." />
  <meta name="keywords" content="krizvibe, code editor, ai code editor, html css js playground, monaco editor, web editor, vibe coding, pollinations ai" />
  <link rel="canonical" href="https://cloudcompile.github.io/htmleditor/" />
  
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="KrizVibe Editor – AI-Powered Code Editor" />
  <meta property="og:description" content="Vibe coding with KrizVibe AI, Monaco-powered HTML/CSS/JS editor, and secure local project storage." />
  <meta property="og:url" content="https://cloudcompile.github.io/htmleditor/" />
  <meta property="og:image" content="https://cloudcompile.github.io/htmleditor/img/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:alt" content="KrizVibe Editor Logo" />
  <meta property="og:site_name" content="KrizVibe Editor" />
  
  <!-- Twitter / X Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="KrizVibe Editor – AI-Powered Code Editor" />
  <meta name="twitter:description" content="AI-powered HTML/CSS/JS playground with KrizVibe AI, Monaco editor, and local project saving." />
  <meta name="twitter:image" content="https://cloudcompile.github.io/htmleditor/img/logo.png" />
  <meta name="twitter:site" content="@altkriz" />
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root {
      /* Color Palette - Midnight Pro */
      --bg-app: #0d1117;
      --bg-panel: #161b22;
      --bg-input: #010409;
      --border: #30363d;
      --accent: #2f81f7;
      --accent-hover: #58a6ff;
      --text-main: #c9d1d9;
      --text-muted: #8b949e;
      --success: #238636;
      --danger: #da3633;
      
      --header-h: 50px;
      --font-ui: 'Inter', system-ui, sans-serif;
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      background-color: var(--bg-app);
      color: var(--text-main);
      font-family: var(--font-ui);
      height: 100vh;
      overflow: auto; /* Bug 33: Allow scrolling on small screens */
      display: flex;
      flex-direction: column;
    }

    /* --- Header --- */
    .app-header {
      height: var(--header-h);
      background-color: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
      z-index: 30;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--text-main);
      font-size: 15px;
    }
    .brand i { color: var(--accent); }

    .header-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-family: var(--font-ui);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn:hover { background: #21262d; border-color: #8b949e; }
    .btn.primary { background: var(--success); color: white; border-color: rgba(255,255,255,0.1); }
    .btn.primary:hover { background: #2ea043; }
    
    .icon-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      padding: 8px;
      border-radius: 4px;
      transition: color 0.2s;
    }
    .icon-btn:hover { color: var(--accent-hover); background: rgba(255,255,255,0.05); }

    .input-field {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-family: var(--font-ui);
    }
    .input-field:focus { border-color: var(--accent); }

    /* --- Main Workspace (Flex Column) --- */
    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column; /* STACK VERTICALLY */
      overflow: hidden;
      position: relative;
    }

    /* --- Split View (Editor | Preview) --- */
    .split-view {
      flex: 1; /* Takes all available height not used by AI drawer */
      display: flex;
      flex-direction: row;
      overflow: hidden;
      min-height: 0; /* Important for flex scrolling */
    }

    /* Left Panel: Editor */
    .editor-pane {
      width: 50%;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      background: var(--bg-app);
      min-width: 0;
    }

    .tabs-container {
      display: flex;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      height: 36px;
      flex-shrink: 0;
    }
    .tab {
      padding: 0 16px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      border-right: 1px solid var(--border);
      background: transparent;
      display: flex;
      align-items: center;
      gap: 6px;
      height: 100%;
    }
    .tab:hover { background: var(--bg-app); color: var(--text-main); }
    .tab.active {
      background: var(--bg-app);
      color: var(--accent-hover);
      border-top: 2px solid var(--accent);
    }
    
    .editor-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      padding-right: 10px;
      gap: 8px;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
    .status-dot.saving { background: #e3b341; }
    .status-dot.saved { background: var(--success); }

    #monaco-host {
      flex: 1;
      overflow: hidden;
    }

    /* Right Panel: Preview */
    .preview-pane {
      width: 50%;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      min-width: 0;
    }
    
    .preview-header {
      height: 36px;
      background: #f0f0f0;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      color: #333;
      font-size: 12px;
      flex-shrink: 0;
    }
    
    .url-bar {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 2px 10px;
      color: #666;
      width: 200px;
      text-align: center;
      font-size: 11px;
    }

    iframe { border: none; width: 100%; flex: 1; }

    /* --- AI Drawer (Normal Flex Item) --- */
    .ai-drawer {
      /* No absolute positioning! It sits naturally below split-view */
      height: 40px; /* Collapsed height */
      background: var(--bg-panel);
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: height 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 10;
      flex-shrink: 0; /* Prevent it from getting squished */
    }
    .ai-drawer.open { height: 350px; }

    .ai-header {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      cursor: pointer;
      border-bottom: 1px solid transparent;
      flex-shrink: 0;
    }
    .ai-drawer.open .ai-header { border-bottom-color: var(--border); }
    
    .ai-title {
      font-weight: 600;
      color: var(--accent-hover);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .ai-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .ai-drawer.open .ai-content { opacity: 1; pointer-events: all; }

    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-family: var(--font-ui);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 8px;
      line-height: 1.5;
    }
    .chat-msg.user { align-self: flex-end; background: var(--accent); color: white; }
    .chat-msg.ai { align-self: flex-start; background: #21262d; border: 1px solid var(--border); color: var(--text-main); }
    
    .chat-input-area {
      padding: 10px 16px;
      background: var(--bg-input);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }
    #ai-input { flex: 1; background: transparent; border: none; color: white; font-family: var(--font-ui); font-size: 14px; }
    #ai-send { background: var(--accent); border: none; color: white; border-radius: 4px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    /* --- Side Panel (Projects) --- */
    .side-panel {
      position: fixed;
      top: var(--header-h);
      bottom: 0;
      left: -300px;
      width: 300px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      z-index: 50;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .side-panel.active { left: 0; }
    .panel-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;}
    .panel-content { flex: 1; overflow-y: auto; padding: 10px; }
    
    .project-card {
      background: var(--bg-app);
      border: 1px solid var(--border);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .project-card:hover { border-color: var(--accent); }
    .project-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 6px; }
    .project-actions { margin-top: 8px; display: flex; gap: 5px; justify-content: flex-end; }

    /* --- Modal --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      width: 400px;
      max-width: 90%;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .social-links { display: flex; gap: 15px; margin-top: 20px; justify-content: center; }
    .social-links a { color: var(--text-muted); font-size: 20px; transition: color 0.2s; }
    .social-links a:hover { color: var(--accent); }

    /* Responsive */
    @media (max-width: 768px) {
      .split-view { flex-direction: column; }
      .editor-pane, .preview-pane { width: 100%; height: 50%; }
      
      /* Bug 34: Responsive sidebar width */
      .side-panel {
        width: 85%;
        max-width: 300px;
        left: -85%;
      }
      .side-panel.active { left: 0; }
    }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-app); }
    ::-webkit-scrollbar-thumb { background: #484f58; border-radius: 4px; }
    
    /* Accessibility - Screen reader only text */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="brand">
      <i class="fa-solid fa-bolt"></i>
      KrizVibe Editor
    </div>
    <div class="header-controls">
      <button class="btn" id="btn-projects"><i class="fa-regular fa-folder-open"></i> Projects</button>
      <button class="btn" id="btn-new"><i class="fa-solid fa-plus"></i> New</button>
      <label for="filename-input" class="sr-only">Project Name</label>
      <input type="text" id="filename-input" class="input-field" placeholder="project-name" value="untitled" aria-label="Project name">
      <button class="btn primary" id="btn-save"><i class="fa-solid fa-floppy-disk"></i> Save</button>
      <button class="btn" id="btn-download" title="Download HTML" aria-label="Download HTML"><i class="fa-solid fa-download"></i></button>
      <button class="icon-btn" id="btn-about" title="About" aria-label="About KrizVibe Editor"><i class="fa-regular fa-circle-question"></i></button>
    </div>
  </header>

  <!-- Projects Sidebar -->
  <aside class="side-panel" id="side-panel">
    <div class="panel-header">
      <span>Saved Projects</span>
      <button class="icon-btn" id="close-side" aria-label="Close sidebar"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="panel-content" id="projects-list"></div>
  </aside>

  <!-- Main Workspace -->
  <div class="workspace">
    
    <!-- SPLIT VIEW WRAPPER -->
    <div class="split-view">
      <!-- Editor Column -->
      <div class="editor-pane">
        <div class="tabs-container" role="tablist" aria-label="Code editor tabs">
          <div class="tab active" data-lang="html" role="tab" aria-selected="true" aria-controls="monaco-host" tabindex="0"><i class="fa-brands fa-html5" style="color:#e34c26"></i> HTML</div>
          <div class="tab" data-lang="css" role="tab" aria-selected="false" aria-controls="monaco-host" tabindex="-1"><i class="fa-brands fa-css3-alt" style="color:#264de4"></i> CSS</div>
          <div class="tab" data-lang="js" role="tab" aria-selected="false" aria-controls="monaco-host" tabindex="-1"><i class="fa-brands fa-js" style="color:#f7df1e"></i> JS</div>
          
          <div class="editor-actions">
            <div class="status-dot" id="autosave-dot" title="Autosave Status"></div>
            <button class="icon-btn" id="btn-run" title="Force Run" aria-label="Force run preview"><i class="fa-solid fa-play"></i></button>
          </div>
        </div>
        <div id="monaco-host"></div>
      </div>

      <!-- Preview Column -->
      <div class="preview-pane">
        <div class="preview-header">
          <div style="display:flex; gap:6px">
            <div style="width:10px; height:10px; border-radius:50%; background:#ff5f56"></div>
            <div style="width:10px; height:10px; border-radius:50%; background:#ffbd2e"></div>
            <div style="width:10px; height:10px; border-radius:50%; background:#27c93f"></div>
          </div>
          <div class="url-bar">localhost:8080/preview</div>
          <button class="icon-btn" id="btn-open-new" style="color:#333" aria-label="Open preview in new window"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
        </div>
        <iframe id="preview-frame" sandbox="allow-scripts"></iframe>
      </div>
    </div>
    <!-- END SPLIT VIEW -->

    <!-- AI Drawer (Now sits below split view, doesn't overlay) -->
    <div class="ai-drawer" id="ai-drawer">
      <div class="ai-header" id="ai-toggle" aria-expanded="false" aria-controls="ai-content">
        <div class="ai-title"><i class="fa-solid fa-robot"></i> KrizVibe AI Assistant</div>
        <i class="fa-solid fa-chevron-up" id="ai-chevron"></i>
      </div>
      <div class="ai-content" id="ai-content">
        <div class="chat-area" id="chat-area" aria-live="polite" aria-atomic="false">
          <div class="chat-msg ai">
            <strong>AI:</strong> Ready to code. Describe what you want to build (e.g., "A login form with a dark glassmorphism theme").
          </div>
        </div>
        <div class="chat-input-area">
          <label for="ai-input" class="sr-only">AI Prompt</label>
          <input type="text" id="ai-input" placeholder="Ask KrizVibe to generate code..." autocomplete="off" aria-label="AI prompt input">
          <button id="ai-send" aria-label="Send AI prompt"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </div>
    </div>

  </div>

  <!-- About Modal -->
  <div class="modal-overlay" id="about-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-box">
      <h2 id="modal-title" style="margin-top:0; color:var(--accent)">About KrizVibe</h2>
      <p style="color:var(--text-muted); line-height:1.6">
        Experience the vibe of coding with KrizVibe, a real-time HTML, CSS, and JavaScript editor powered by AI.
      </p>
      <div class="social-links">
        <a href="https://github.com/altkriz" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-github"></i></a>
        <a href="https://x.com/altkriz" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-twitter"></i></a>
      </div>
      <div style="text-align:right; margin-top:20px;">
        <button class="btn" id="close-about">Close</button>
      </div>
    </div>
  </div>

  <!-- Monaco Editor Loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>

  <script>
    // --- Core Variables ---
    let editor, htmlModel, cssModel, jsModel;
    let activeLang = 'html';
    const PROJECT_KEY = 'krizvibe_projects_v2';
    const AUTOSAVE_KEY = 'krizvibe_autosave_draft';
    const LAST_PROJECT_KEY = 'krizvibe_last_project';
    const AI_CONSENT_KEY = 'krizvibe_ai_consent';
    let currentProjectId = null;
    let autosaveTimer;
    let autosaveDraftTimer;

    // --- Defaults ---
    const DEFAULT_CODE = {
      html: '<div class="container">\n  <h1>Hello KrizVibe</h1>\n  <p>Start editing or ask AI to build something!</p>\n  <button id="btn">Click Me</button>\n</div>',
      css: 'body {\n  font-family: "Inter", sans-serif;\n  background: #f0f2f5;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100vh;\n  margin: 0;\n}\n\n.container {\n  background: white;\n  padding: 2rem;\n  border-radius: 12px;\n  box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n  text-align: center;\n}\n\nh1 { color: #2f81f7; }\n\nbutton {\n  background: #2f81f7;\n  color: white;\n  border: none;\n  padding: 10px 20px;\n  border-radius: 6px;\n  cursor: pointer;\n  font-weight: 600;\n}\nbutton:hover { background: #58a6ff; }',
      js: 'document.getElementById("btn").addEventListener("click", () => {\n  alert("Welcome to KrizVibe Editor!");\n});'
    };

    // --- Initialization ---
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' }});
    
    // Bug 13: Disable controls until Monaco is ready
    const controlsToDisable = ['btn-save', 'btn-run', 'btn-download', 'btn-new', 'btn-projects'];
    controlsToDisable.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.disabled = true;
    });
    
    // Bug 30: Add error handling for Monaco loader
    window.monacoLoadTimeout = setTimeout(() => {
      alert('Failed to load Monaco Editor. Please check your internet connection and refresh the page.');
    }, 15000);
    
    require(['vs/editor/editor.main'], function() {
      clearTimeout(window.monacoLoadTimeout);
      
      htmlModel = monaco.editor.createModel(DEFAULT_CODE.html, 'html');
      cssModel = monaco.editor.createModel(DEFAULT_CODE.css, 'css');
      jsModel = monaco.editor.createModel(DEFAULT_CODE.js, 'javascript');

      editor = monaco.editor.create(document.getElementById('monaco-host'), {
        model: htmlModel,
        theme: 'vs-dark',
        fontSize: 14,
        fontFamily: 'JetBrains Mono',
        minimap: { enabled: false },
        automaticLayout: false, // We handle layout manually for better performance
        padding: { top: 20 },
        scrollBeyondLastLine: false,
        smoothScrolling: true
      });

      // Add auto-resize observer
      window.addEventListener('resize', () => editor.layout());

      htmlModel.onDidChangeContent(triggerUpdate);
      cssModel.onDidChangeContent(triggerUpdate);
      jsModel.onDidChangeContent(triggerUpdate);

      updatePreview();
      loadProjectsFromStorage();
      
      // Bug 19: Restore autosave draft if available
      restoreAutosaveDraft();
      
      // Bug 48: Restore last opened project
      try {
        const lastProjectId = localStorage.getItem(LAST_PROJECT_KEY);
        if (lastProjectId) {
          const projects = getProjects();
          const lastProject = projects.find(p => p.id === lastProjectId);
          if (lastProject) {
            htmlModel.setValue(lastProject.html);
            cssModel.setValue(lastProject.css);
            jsModel.setValue(lastProject.js);
            filenameInput.value = lastProject.name;
            currentProjectId = lastProject.id;
            updatePreview();
          }
        }
      } catch (err) {
        console.error('Failed to restore last project:', err);
      }
      
      // Bug 13: Re-enable controls after Monaco is ready
      controlsToDisable.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = false;
      });
    }, function(err) {
      // Bug 30: Handle Monaco load error
      clearTimeout(window.monacoLoadTimeout);
      console.error('Monaco failed to load:', err);
      alert('Failed to load Monaco Editor: ' + err.message + '\nPlease refresh the page.');
    });

    // --- Tab Logic ---
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab));
      
      // Bug 35: Keyboard navigation for tabs
      tab.addEventListener('keydown', (e) => {
        const tabs = Array.from(document.querySelectorAll('.tab'));
        const currentIndex = tabs.indexOf(tab);
        
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          switchTab(tab);
        } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
          e.preventDefault();
          tabs[currentIndex - 1].focus();
        } else if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
          e.preventDefault();
          tabs[currentIndex + 1].focus();
        }
      });
    });
    
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
        t.setAttribute('tabindex', '-1');
      });
      tab.classList.add('active');
      tab.setAttribute('aria-selected', 'true');
      tab.setAttribute('tabindex', '0');
      activeLang = tab.dataset.lang;
      
      if(activeLang === 'html') editor.setModel(htmlModel);
      if(activeLang === 'css') editor.setModel(cssModel);
      if(activeLang === 'js') editor.setModel(jsModel);
      
      editor.focus();
    }

    // --- Preview Logic ---
    function getCombinedCode() {
      const html = htmlModel.getValue();
      const css = cssModel.getValue();
      const js = jsModel.getValue();
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <style>${css}</style>
        </head>
        <body>
          ${html}
          <script>${js}<\/script>
        </body>
        </html>
      `;
    }

    function updatePreview() {
      const frame = document.getElementById('preview-frame');
      frame.srcdoc = getCombinedCode();
      document.getElementById('autosave-dot').classList.remove('saving');
      document.getElementById('autosave-dot').classList.add('saved');
    }

    function triggerUpdate() {
      document.getElementById('autosave-dot').classList.add('saving');
      document.getElementById('autosave-dot').classList.remove('saved');
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(updatePreview, 1000);
      
      // Bug 19: Autosave draft to localStorage
      clearTimeout(autosaveDraftTimer);
      autosaveDraftTimer = setTimeout(autosaveDraft, 2000);
    }
    
    // Bug 19: Implement autosave to localStorage
    function autosaveDraft() {
      try {
        const draft = {
          html: htmlModel.getValue(),
          css: cssModel.getValue(),
          js: jsModel.getValue(),
          timestamp: Date.now()
        };
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(draft));
      } catch (err) {
        console.error('Failed to autosave draft:', err);
      }
    }
    
    // Bug 19: Restore autosaved draft on load
    function restoreAutosaveDraft() {
      try {
        const saved = localStorage.getItem(AUTOSAVE_KEY);
        if (saved) {
          const draft = JSON.parse(saved);
          // Only restore if it's recent (within 24 hours) and user confirms
          const age = Date.now() - draft.timestamp;
          if (age < 24 * 60 * 60 * 1000) {
            if (confirm('Restore unsaved work from previous session?')) {
              htmlModel.setValue(draft.html);
              cssModel.setValue(draft.css);
              jsModel.setValue(draft.js);
              updatePreview();
            }
          }
        }
      } catch (err) {
        console.error('Failed to restore autosave:', err);
      }
    }

    document.getElementById('btn-run').addEventListener('click', updatePreview);

    // --- AI Logic (Pollinations) ---
    const aiDrawer = document.getElementById('ai-drawer');
    const aiToggle = document.getElementById('ai-toggle');
    const aiInput = document.getElementById('ai-input');
    const aiSend = document.getElementById('ai-send');
    const chatArea = document.getElementById('chat-area');

    // Toggle Drawer and Resize Editor
    aiToggle.addEventListener('click', () => {
      aiDrawer.classList.toggle('open');
      const icon = document.getElementById('ai-chevron');
      const isOpen = aiDrawer.classList.contains('open');
      
      // Bug 40: Update aria-expanded
      aiToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      
      if(isOpen) {
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        aiInput.focus();
      } else {
        icon.classList.add('fa-chevron-up');
        icon.classList.remove('fa-chevron-down');
      }

      // IMPORTANT: Trigger editor layout update after transition
      // This ensures code doesn't get hidden/cut off
      setTimeout(() => {
        if(editor) editor.layout();
      }, 300); // Match CSS transition time
    });

    async function sendMessage() {
      const text = aiInput.value.trim();
      if(!text) return;

      // Bug 10: Check for AI consent
      try {
        const consent = localStorage.getItem(AI_CONSENT_KEY);
        if (consent !== 'true') {
          const userConsent = confirm(
            'AI Code Sharing Notice:\n\n' +
            'Using the AI assistant will send your current HTML, CSS, and JavaScript code along with your prompt to the Pollinations AI service (a third-party API).\n\n' +
            'Your code will be transmitted over the internet to generate AI responses. Do not use this feature with sensitive or private code.\n\n' +
            'Do you consent to sharing your code with the AI service?'
          );
          
          if (!userConsent) {
            return;
          }
          
          localStorage.setItem(AI_CONSENT_KEY, 'true');
        }
      } catch (err) {
        console.error('Failed to check AI consent:', err);
      }

      addChatMsg('user', text);
      aiInput.value = '';
      aiInput.disabled = true;
      
      const spinnerMsg = addChatMsg('ai', '<i class="fa-solid fa-spinner fa-spin"></i> Generating code...');

      const currentCode = `HTML: ${htmlModel.getValue()}\nCSS: ${cssModel.getValue()}\nJS: ${jsModel.getValue()}`;
      
      // Bug 49: Warn if context is too large
      if (currentCode.length > 10000) {
        console.warn('Large code context may exceed AI model limits:', currentCode.length, 'characters');
      }

      const systemPrompt = `You are KrizVibe AI, an expert web developer.
      Current Code Context:
      ${currentCode}
      
      User Request: ${text}
      
      Instructions:
      1. Return ONLY the updated code.
      2. Format response strictly as:
      [HTML]
      ...code...
      [CSS]
      ...code...
      [JS]
      ...code...
      3. Do not include explanations outside the code.
      `;

      // Bug 31: Add timeout/abort handling
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

      try {
        const response = await fetch('https://text.pollinations.ai/openai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'openai',
            messages: [{ role: 'system', content: systemPrompt }]
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        
        // Bug 32: Check HTTP status
        if (!response.ok) {
          throw new Error(`AI service returned status ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        const reply = data.choices[0].message.content;
        
        // Bug 12: Guard before removing spinner
        if (spinnerMsg && spinnerMsg.parentNode === chatArea) {
          chatArea.removeChild(spinnerMsg);
        }
        
        // Bug 11: Validate AI response format
        const htmlMatch = reply.match(/\[HTML\]([\s\S]*?)(\[CSS\]|$)/);
        const cssMatch = reply.match(/\[CSS\]([\s\S]*?)(\[JS\]|$)/);
        const jsMatch = reply.match(/\[JS\]([\s\S]*?)($)/);

        if (!htmlMatch && !cssMatch && !jsMatch) {
          addChatMsg('ai', "Error: AI response format invalid. Expected [HTML], [CSS], and [JS] sections.");
          return;
        }

        if(htmlMatch && htmlMatch[1].trim()) htmlModel.setValue(htmlMatch[1].trim());
        if(cssMatch && cssMatch[1].trim()) cssModel.setValue(cssMatch[1].trim());
        if(jsMatch && jsMatch[1].trim()) jsModel.setValue(jsMatch[1].trim());

        addChatMsg('ai', "Code updated based on your request.");
        updatePreview();

      } catch (err) {
        clearTimeout(timeoutId);
        // Bug 12: Guard before removing spinner on error
        if (spinnerMsg && spinnerMsg.parentNode === chatArea) {
          chatArea.removeChild(spinnerMsg);
        }
        
        let errorMsg = "Error: " + err.message;
        if (err.name === 'AbortError') {
          errorMsg = "Error: Request timed out. Please try again.";
        }
        addChatMsg('ai', errorMsg);
      } finally {
        aiInput.disabled = false;
        aiInput.focus();
      }
    }

    function addChatMsg(role, text) {
      const div = document.createElement('div');
      div.className = `chat-msg ${role}`;
      // Use textContent to prevent XSS attacks (Bug 1)
      if (text.includes('<i class="fa-solid fa-spinner fa-spin"></i>')) {
        // Allow spinner HTML only
        div.innerHTML = text;
      } else {
        div.textContent = text;
      }
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
      return div; // Return element for tracking (Bug 12)
    }

    aiSend.addEventListener('click', sendMessage);
    aiInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') sendMessage(); });

    // --- Project Management (LocalStorage) ---
    const sidePanel = document.getElementById('side-panel');
    const projectsList = document.getElementById('projects-list');
    const filenameInput = document.getElementById('filename-input');
    const closeSideBtn = document.getElementById('close-side');
    let lastFocusedBeforeSidebar = null;

    document.getElementById('btn-projects').addEventListener('click', () => {
      // Bug 39: Save last focused element
      lastFocusedBeforeSidebar = document.activeElement;
      sidePanel.classList.add('active');
      // Move focus to close button
      closeSideBtn.focus();
    });
    
    closeSideBtn.addEventListener('click', () => {
      sidePanel.classList.remove('active');
      // Bug 39: Restore focus
      if (lastFocusedBeforeSidebar) {
        lastFocusedBeforeSidebar.focus();
      }
    });

    function getProjects() {
      // Bug 14, Bug 15: Wrap localStorage access and JSON.parse in try/catch
      try {
        const data = localStorage.getItem(PROJECT_KEY);
        if (!data) return [];
        return JSON.parse(data);
      } catch (err) {
        console.error('Failed to load projects:', err);
        // Return empty array and optionally reset corrupted data
        try {
          localStorage.setItem(PROJECT_KEY, '[]');
        } catch (e) {
          console.error('Failed to reset projects:', e);
        }
        return [];
      }
    }

    function saveProject() {
      const name = filenameInput.value.trim() || "Untitled";
      const projects = getProjects();
      
      const newProject = {
        id: currentProjectId || Date.now().toString(),
        name: name,
        html: htmlModel.getValue(),
        css: cssModel.getValue(),
        js: jsModel.getValue(),
        date: new Date().toLocaleString()
      };

      const index = projects.findIndex(p => p.id === newProject.id);
      if(index >= 0) projects[index] = newProject;
      else projects.unshift(newProject);

      // Bug 16: Catch localStorage.setItem errors
      try {
        localStorage.setItem(PROJECT_KEY, JSON.stringify(projects));
        currentProjectId = newProject.id;
        // Bug 48: Remember last project
        localStorage.setItem(LAST_PROJECT_KEY, currentProjectId);
        alert('Project Saved!');
        renderProjects();
      } catch (err) {
        console.error('Failed to save project:', err);
        alert('Failed to save project: ' + (err.message || 'Storage quota exceeded or blocked'));
      }
    }

    document.getElementById('btn-save').addEventListener('click', saveProject);

    function renderProjects() {
      const projects = getProjects();
      projectsList.innerHTML = '';
      if(projects.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.cssText = 'color:var(--text-muted); font-size:12px; text-align:center; margin-top:20px';
        emptyMsg.textContent = 'No saved projects';
        projectsList.appendChild(emptyMsg);
        return;
      }
      
      projects.forEach(p => {
        // Build DOM nodes to prevent XSS (Bug 2, Bug 17)
        const card = document.createElement('div');
        card.className = 'project-card';
        card.setAttribute('tabindex', '0'); // Bug 42: Make keyboard focusable
        card.setAttribute('role', 'button'); // Bug 42: Add role
        card.setAttribute('aria-label', 'Project: ' + p.name);
        
        const nameDiv = document.createElement('div');
        nameDiv.style.cssText = 'font-weight:600; font-size:13px;';
        nameDiv.textContent = p.name;
        
        const metaDiv = document.createElement('div');
        metaDiv.className = 'project-meta';
        metaDiv.textContent = p.date;
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'project-actions';
        
        // Bug 3: Use addEventListener instead of inline onclick
        const loadBtn = document.createElement('button');
        loadBtn.className = 'icon-btn';
        loadBtn.setAttribute('data-project-id', p.id);
        loadBtn.setAttribute('aria-label', 'Load project ' + p.name);
        loadBtn.innerHTML = '<i class="fa-solid fa-folder-open"></i>';
        loadBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          loadProject(p.id);
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon-btn';
        deleteBtn.style.color = 'var(--danger)';
        deleteBtn.setAttribute('data-project-id', p.id);
        deleteBtn.setAttribute('aria-label', 'Delete project ' + p.name);
        deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteProject(p.id);
        });
        
        actionsDiv.appendChild(loadBtn);
        actionsDiv.appendChild(deleteBtn);
        
        card.appendChild(nameDiv);
        card.appendChild(metaDiv);
        card.appendChild(actionsDiv);
        
        // Bug 42: Add keyboard support for card
        card.addEventListener('click', () => loadProject(p.id));
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            loadProject(p.id);
          }
        });
        
        projectsList.appendChild(card);
      });
    }

    window.loadProject = (id) => {
      const projects = getProjects();
      const p = projects.find(proj => proj.id === id);
      // Bug 46: Show error when project not found
      if(p) {
        htmlModel.setValue(p.html);
        cssModel.setValue(p.css);
        jsModel.setValue(p.js);
        filenameInput.value = p.name;
        currentProjectId = p.id;
        // Bug 48: Remember last project
        try {
          localStorage.setItem(LAST_PROJECT_KEY, p.id);
        } catch (err) {
          console.error('Failed to save last project:', err);
        }
        sidePanel.classList.remove('active');
        updatePreview();
      } else {
        alert('Error: Project not found');
      }
    };

    window.deleteProject = (id) => {
      if(confirm('Delete this project?')) {
        const projects = getProjects().filter(p => p.id !== id);
        // Bug 16: Wrap localStorage in try/catch
        try {
          localStorage.setItem(PROJECT_KEY, JSON.stringify(projects));
        } catch (err) {
          console.error('Failed to delete project:', err);
          alert('Failed to delete project: ' + err.message);
          return;
        }
        
        // Bug 45: Clear editors when deleting active project
        if(currentProjectId === id) {
          currentProjectId = null;
          htmlModel.setValue(DEFAULT_CODE.html);
          cssModel.setValue(DEFAULT_CODE.css);
          jsModel.setValue(DEFAULT_CODE.js);
          filenameInput.value = 'untitled';
          updatePreview();
        }
        renderProjects();
      }
    };

    document.getElementById('btn-new').addEventListener('click', () => {
      if(confirm('Start new project? Unsaved changes will be lost.')) {
        htmlModel.setValue(DEFAULT_CODE.html);
        cssModel.setValue(DEFAULT_CODE.css);
        jsModel.setValue(DEFAULT_CODE.js);
        filenameInput.value = 'untitled';
        currentProjectId = null;
        updatePreview();
      }
    });

    function loadProjectsFromStorage() { renderProjects(); }

    // --- Other Actions ---
    document.getElementById('btn-download').addEventListener('click', () => {
      // Bug 44: Sanitize filename
      const rawFilename = filenameInput.value || 'project';
      const sanitizedFilename = rawFilename.replace(/[^a-zA-Z0-9_-]/g, '_');
      
      const blob = new Blob([getCombinedCode()], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = sanitizedFilename + '.html';
      a.click();
      
      // Bug 43: Revoke object URL to prevent memory leak
      setTimeout(() => URL.revokeObjectURL(url), 100);
    });

    document.getElementById('btn-open-new').addEventListener('click', () => {
      const win = window.open('', '_blank', 'noopener,noreferrer');
      if (win) {
        win.opener = null; // Additional protection
        win.document.write(getCombinedCode());
        win.document.close();
      }
    });

    const aboutModal = document.getElementById('about-modal');
    const closeAboutBtn = document.getElementById('close-about');
    let lastFocusedElement = null;
    
    document.getElementById('btn-about').addEventListener('click', () => {
      // Bug 38: Save last focused element and trap focus
      lastFocusedElement = document.activeElement;
      aboutModal.classList.add('active');
      closeAboutBtn.focus();
    });
    
    closeAboutBtn.addEventListener('click', () => {
      aboutModal.classList.remove('active');
      // Bug 38: Restore focus
      if (lastFocusedElement) {
        lastFocusedElement.focus();
      }
    });
    
    aboutModal.addEventListener('click', (e) => {
      if(e.target === aboutModal) {
        aboutModal.classList.remove('active');
        // Bug 38: Restore focus
        if (lastFocusedElement) {
          lastFocusedElement.focus();
        }
      }
    });
    
    // Bug 38: Trap focus within modal when open
    aboutModal.addEventListener('keydown', (e) => {
      if (!aboutModal.classList.contains('active')) return;
      
      if (e.key === 'Escape') {
        aboutModal.classList.remove('active');
        if (lastFocusedElement) {
          lastFocusedElement.focus();
        }
      }
      
      if (e.key === 'Tab') {
        const focusableElements = aboutModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        if (e.shiftKey && document.activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
        } else if (!e.shiftKey && document.activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
        }
      }
    });

  </script>
</body>
</html>

