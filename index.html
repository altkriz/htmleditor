<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrizCode Editor</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#0f1720;
      --panel:#111214;
      --muted:#9aa4b2;
      --accent:#0078d4;
      --glass: rgba(255,255,255,0.03);
      --success:#4caf50;
      --danger:#e05656;
    }
    /* Light theme overrides (applied when body has .light) */
    body.light{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --muted: #475569;
      --accent: #0b5cff;
      --glass: rgba(2,6,23,0.03);
      --success: #2e7d32;
      --danger: #c62828;
      color-scheme: light;
    }
    *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  /* Use CSS variable for background so theme toggle can update it */
  body{background:var(--bg);color:var(--muted);display:flex;flex-direction:column;min-height:100vh;transition:background .2s,color .15s}
    /* Navbar */
    .navbar{height:56px;padding:8px 14px;background:var(--panel);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.03);}
    .nav-left{display:flex;align-items:center;gap:12px}
    .logo{font-weight:700;color:var(--accent);font-size:1.05rem}
    .nav-actions{display:flex;gap:8px;align-items:center}
    .icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:6px 10px;border-radius:6px;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .icon-btn:hover{border-color:var(--accent);color:var(--accent)}
    /* Container layout */
   /* Keep a sensible minimum width for the editor column and allow toolbar wrapping
     to avoid buttons overflowing into the preview column on narrow screens */
   .container{display:grid;grid-template-columns:minmax(320px, 1fr) 2fr;gap:12px;padding:12px;flex:1;overflow:hidden}
    /* Editor column */
    .left-col{display:flex;flex-direction:column;background:var(--panel);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);min-width:320px}
    .tabs{display:flex;gap:6px;margin-bottom:8px}
    .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.02)}
    .tab.active{background:linear-gradient(90deg, rgba(0,120,212,0.12), rgba(0,120,212,0.06));color:var(--accent);font-weight:600;border-color:rgba(0,120,212,0.25)}
   .editor-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
   /* Prevent buttons from breaking into multiple visual lines oddly and
     avoid allowing their contents to wrap inside the button */
   .editor-toolbar .btn, .editor-toolbar .icon-btn, .nav-actions .icon-btn{white-space:nowrap}
   /* Allow the right column to shrink properly inside the grid layout (prevents overflow issues) */
   .right-col{min-width:0}
    .small-input{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 8px;border-radius:6px}
    .btn{background:var(--accent);color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn.danger{background:var(--danger)}
    .editor-area{flex:1;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    /* Preview column */
    .right-col{display:flex;flex-direction:column;border-radius:10px;overflow:hidden}
    .preview-top{padding:10px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .preview-iframe{flex:1;background:white;border:none;width:100%}
    /* Side panel (saved projects) */
    .side-panel{position:fixed;left:12px;top:70px;width:320px;height:calc(100vh - 84px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px);border-radius:10px;padding:12px;overflow:auto;box-shadow:0 8px 30px rgba(2,6,23,0.6);transform:translateX(-380px);transition:transform .25s ease;z-index:60}
    .side-panel.open{transform:translateX(0)}
    .side-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .proj-list{display:flex;flex-direction:column;gap:8px}
    .proj-item{padding:8px;border-radius:8px;background:var(--glass);display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.02)}
    .proj-item .meta{font-size:13px;color:var(--muted)}
    .proj-actions{display:flex;gap:6px}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:90}
    .modal-backdrop.show{display:flex}
    .modal{background:var(--panel);padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);width:320px;max-width:94%}
    .modal h3{margin:0 0 8px 0;color:var(--accent)}
    .modal p{color:var(--muted);font-size:14px;margin-bottom:12px}
    .modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    /* small helpers */
    .muted{color:var(--muted);font-size:13px}
    .flex{display:flex;gap:8px}
  /* Social square curved buttons in About (small rounded squares) */
  .social-media-icons a.social-square{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:12px;color:#fff;text-decoration:none;box-shadow:0 6px 18px rgba(2,6,23,0.35);transition:transform .12s ease,box-shadow .12s ease,opacity .12s}
  .social-media-icons a.social-square i{font-size:18px;line-height:1}
  /* Make SVG icons fill the rounded-square container completely while keeping small inner padding
    so the glyph isn't clipped. This makes the icon occupy the available area (100%). */
  .social-media-icons a.social-square svg{width:100%;height:100%;padding:6px;box-sizing:border-box;display:block}
  /* Remove extra font-size growth for icon fonts (we rely on SVG sizing now) */
  .social-media-icons a.social-square i{font-size:inherit}
  .social-media-icons a.social-square:hover{transform:translateY(-4px);box-shadow:0 10px 26px rgba(2,6,23,0.45);opacity:0.98}
  .social-square.twitter{background:#0f1724} /* dark rounded square for X */
  .social-square.facebook{background:#1877f2}
  .social-square.instagram{background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888)}
  .social-square.github{background:#0d1117}
  .social-square.site{background:#16a34a}
  /* About page styles */
  .about-section h1{font-size:1.6rem}
  .about-section p{line-height:1.6;color:var(--muted)}
  .about-section footer a{opacity:0.95}

  /* ---- KrizVibe AI Styles ---- */
  #krizvibe-ai-bar{background:var(--panel);border-top:1px solid rgba(255,255,255,0.05);height:50px;width:100%;transition:height 0.25s ease;overflow:hidden;flex-shrink:0}
  #krizvibe-ai-bar.expanded{height:40vh;max-height:45%}
  #krizvibe-header{display:flex;align-items:center;gap:12px;padding:0 14px;height:50px;cursor:pointer;}
  #krizvibe-header .icon{font-size:20px;color:var(--accent);width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--glass);border-radius:8px;}
  #krizvibe-header h3{margin:0;font-size:1rem;color:var(--accent);font-weight:600;}
  #krizvibe-toggle{margin-left:auto;transition:transform .2s ease}
  #krizvibe-ai-bar.expanded #krizvibe-toggle{transform:rotate(180deg)}
  #krizvibe-content{display:flex;flex-direction:column;height:calc(100% - 50px);padding:0 14px 14px 14px}
  #krizvibe-chat{flex:1;overflow-y:auto;padding:8px;background:var(--glass);border-radius:8px;display:flex;flex-direction:column;gap:10px}
  .ai-message{padding:8px 12px;border-radius:8px;max-width:85%;line-height:1.5;display:flex;flex-direction:column;gap:4px}
  .ai-message.user{background:var(--accent);color:white;align-self:flex-end}
  .ai-message.assistant{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);align-self:flex-start}
  .ai-message .role{font-size:11px;font-weight:700;opacity:0.6}
  .ai-message pre{margin:0;white-space:pre-wrap;word-wrap:break-word;background:rgba(0,0,0,0.2);padding:6px 8px;border-radius:6px;font-size:12px}
  #krizvibe-input-area{display:flex;gap:8px;margin-top:10px}
  #krizvibe-input{flex:1;background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:8px 12px;border-radius:6px;font-size:14px}
  #krizvibe-input:focus{border-color:var(--accent)}
  #krizvibe-send{width:42px;height:42px;padding:0}

    @media (max-width:900px){
      .container{grid-template-columns:1fr;grid-template-rows:1fr 1fr;padding:8px;overflow:auto}
      .left-col{min-height:320px}
      .side-panel{left:8px;top:64px}
      #krizvibe-ai-bar.expanded{height:45vh}
    }
  </style>
</head>
<body>

  <div class="navbar">
    <div class="nav-left">
      <div class="logo"><i class="fa-solid fa-code"></i> KrizCode Editor</div>
      
    </div>

    <div class="nav-actions">
      <button class="icon-btn" id="toggle-side"><i class="fa-solid fa-folder-open"></i> Projects</button>
      <button class="icon-btn" id="new-project-btn"><i class="fa-solid fa-file-circle-plus"></i> New</button>
      <button class="icon-btn" id="save-project-btn"><i class="fa-solid fa-floppy-disk"></i> Save</button>
      <button class="icon-btn" id="theme-toggle" title="Toggle day/night"><i class="fa-solid fa-sun"></i></button>
      <button class="icon-btn" id="about-btn" title="About KrizCode"><i class="fa-solid fa-circle-info"></i> About</button>
    </div>
  </div>

  <div class="container">
    <!-- Left: Editor -->
    <div class="left-col">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="html">HTML</div>
        <div class="tab" data-tab="css">CSS</div>
        <div class="tab" data-tab="js">JS</div>
      </div>

      <div class="editor-toolbar" style="align-items:center">
        <div class="muted">Auto-save: <span id="autosave-status">off</span></div>
        <div style="flex:1"></div>
        <input id="filename-input" class="small-input" placeholder="Filename for download (required).html" title="This filename is mandatory for downloads" />
        <button class="btn secondary" id="run-btn" title="Update preview (or auto updates)">Run</button>
        <button class="btn" id="open-new-tab"><i class="fa-solid fa-up-right-from-square"></i> Open</button>
        <button class="btn download-btn" id="download-btn"><i class="fa-solid fa-download"></i> Download</button>
      </div>

      <div class="editor-area" id="editor-area"></div>
    </div>

    <!-- Right: Preview -->
    <div class="right-col">
      <div class="preview-top">
        <div class="muted">Live Preview</div>
        <div class="muted" id="preview-updated">Last update: —</div>
      </div>
      <iframe id="preview-frame" class="preview-iframe" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <!-- KrizVibe AI Panel -->
  <div id="krizvibe-ai-bar">
    <div id="krizvibe-header">
      <!-- Using FontAwesome icon as robot.jpg is unavailable -->
      <div class="icon"><i class="fa-solid fa-robot"></i></div>
      <h3>KrizVibe AI</h3>
      <button class="icon-btn" id="krizvibe-toggle" title="Toggle AI Panel"><i class="fa-solid fa-chevron-up"></i></button>
    </div>
    <div id="krizvibe-content">
      <div id="krizvibe-chat">
        <div class="ai-message assistant">
          <span class="role">ASSISTANT</span>
          <div>Hello! Describe the website you want me to create.</div>
        </div>
      </div>
      <div id="krizvibe-input-area">
        <input type="text" id="krizvibe-input" placeholder="e.g., a portfolio page with 3 sections..." autocomplete="off">
        <button class="btn" id="krizvibe-send" title="Send message"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- About section (hidden by default). Displayed when About button clicked -->
  <div id="about-section" class="about-section" style="display:none;padding:28px;max-width:980px;margin:18px auto;color:var(--muted);">
    <div style="background:var(--panel);padding:24px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);">
        <h1 style="margin-top:0;color:var(--accent);">About Us</h1>
        <p>Welcome to the Kriztech Code Editor! Our mission is to provide a simple and intuitive code editor that helps developers write and test their code quickly and efficiently. Our editor is designed with the needs of developers in mind, and we are constantly working to improve and add new features to make your coding experience even better.</p>
        <p>At Kriztech, we believe that coding should be accessible to everyone, regardless of their background or experience level. That's why we offer our editor for free, and we are committed to providing high-quality resources and support to help you succeed in your coding journey.</p>
        <p>Thank you for choosing Kriztech, and happy coding!</p>
    </div>

    <footer style="margin-top:18px;text-align:center;color:var(--muted);">
    <div class="social-media-icons" style="display:flex;gap:12px;justify-content:center;align-items:center;font-size:20px">
            <a class="social-square twitter" href="https://x.com/altkriz" target="_blank" rel="noopener noreferrer" aria-label="X (formerly Twitter)"> <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="28" height="28" viewBox="0 0 50 50" style="fill:currentColor;" aria-hidden="true" focusable="false">
                <path d="M 11 4 C 7.134 4 4 7.134 4 11 L 4 39 C 4 42.866 7.134 46 11 46 L 39 46 C 42.866 46 46 42.866 46 39 L 46 11 C 46 7.134 42.866 4 39 4 L 11 4 z M 13.085938 13 L 21.023438 13 L 26.660156 21.009766 L 33.5 13 L 36 13 L 27.789062 22.613281 L 37.914062 37 L 29.978516 37 L 23.4375 27.707031 L 15.5 37 L 13 37 L 22.308594 26.103516 L 13.085938 13 z M 16.914062 15 L 31.021484 35 L 34.085938 35 L 19.978516 15 L 16.914062 15 z"></path>
              </svg></a>
            <a class="social-square facebook" href="https://www.facebook.com/k.raza193" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><i class="fa-brands fa-facebook-f"></i></a>
            <a class="social-square instagram" href="https://www.instagram.com/k.raza193" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
            <a class="social-square github" href="https://github.com/altkriz" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><i class="fa-brands fa-github"></i></a>
            <a class="social-square site" href="https://altkriz.github.io/" target="_blank" rel="noopener noreferrer" aria-label="Website"><i class="fa-solid fa-globe"></i></a>
    </div>
        <p style="margin-top: 1rem;">© 2023 KrizCode. All rights reserved.</p>
    </footer>
  </div>

  <!-- Side panel: saved projects -->
  <div class="side-panel" id="side-panel" aria-hidden="true">
    <div class="side-header">
      <div style="display:flex;flex-direction:column">
        <strong>Saved Projects</strong>
        <span class="muted">localStorage — stored on this browser</span>
      </div>
      <div>
        <button class="icon-btn" id="close-side"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input id="project-name-input" class="small-input" placeholder="Project name (for Save/Update)" style="flex:1" />
      <button class="btn" id="save-as-btn">Save As</button>
    </div>

    <div style="margin-bottom:8px">
      <button class="icon-btn" id="import-sample">Import Sample</button>
      <button class="icon-btn" id="clear-drafts">Clear Drafts</button>
    </div>

    <div class="proj-list" id="proj-list">
      <!-- Projects will be listed here -->
    </div>
  </div>

  <!-- Modal: require filename for download -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Enter filename</h3>
      <p>You must enter a filename (without extension). The file will be downloaded as <strong>filename.html</strong>.</p>
      <input id="modal-filename" class="small-input" placeholder="my-page" style="width:100%" />
      <div class="modal-actions" style="margin-top:12px">
        <button class="btn secondary" id="modal-cancel">Cancel</button>
        <button class="btn" id="modal-download">Download</button>
      </div>
    </div>
  </div>

  <!-- Monaco loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>

  <script>
  (function(){
    // ---- LocalStorage helpers ----
    const STORAGE_KEY = 'krizcode_projects_v1';
    function loadProjects(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return JSON.parse(raw || '[]');
      } catch(e){
        console.warn('loadProjects: localStorage read failed', e);
        return [];
      }
    }
    function saveProjects(arr){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      } catch(e){
        console.warn('saveProjects: localStorage write failed', e);
        // best-effort: surface to user
        try{ alert('Unable to save projects: storage error.'); }catch(_){ /* ignore */ }
      }
    }

    function nowISO(){ return new Date().toISOString() }

    // ---- UI elements ----
    const sidePanel = document.getElementById('side-panel');
    const toggleSideBtn = document.getElementById('toggle-side');
    const closeSideBtn = document.getElementById('close-side');
    const projListEl = document.getElementById('proj-list');
    const projectNameInput = document.getElementById('project-name-input');
    const saveAsBtn = document.getElementById('save-as-btn');
    const newProjectBtn = document.getElementById('new-project-btn');
    const saveProjectBtn = document.getElementById('save-project-btn');
    const importSampleBtn = document.getElementById('import-sample');
    const clearDraftsBtn = document.getElementById('clear-drafts');

    // Editor UI
    const tabs = document.querySelectorAll('.tab');
    const editorContainer = document.getElementById('editor-area');
    const runBtn = document.getElementById('run-btn');
    const openNewTab = document.getElementById('open-new-tab');
    const downloadBtn = document.getElementById('download-btn');
    const filenameInput = document.getElementById('filename-input');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalFilename = document.getElementById('modal-filename');
    const modalCancel = document.getElementById('modal-cancel');
    const modalDownload = document.getElementById('modal-download');
    const previewFrame = document.getElementById('preview-frame');
    const previewUpdated = document.getElementById('preview-updated');
    const autosaveStatus = document.getElementById('autosave-status');
    const aboutBtn = document.getElementById('about-btn');
    const aboutSectionEl = document.getElementById('about-section');
    const themeToggleBtn = document.getElementById('theme-toggle');

    // ---- KrizVibe AI elements ----
    const aiBar = document.getElementById("krizvibe-ai-bar");
    const aiHeader = document.getElementById("krizvibe-header");
    const aiChat = document.getElementById("krizvibe-chat");
    const aiInput = document.getElementById("krizvibe-input");
    const aiSend = document.getElementById("krizvibe-send");
    const aiToggle = document.getElementById("krizvibe-toggle");

    // Theme helpers
    const THEME_KEY = 'krizcode_theme';
    function applyTheme(theme){
      try{
        document.body.classList.toggle('light', theme === 'light');
        localStorage.setItem(THEME_KEY, theme);
        // update theme icon
        if(themeToggleBtn){
          themeToggleBtn.innerHTML = theme === 'light' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        }
        // try to set Monaco theme if available
        try{ if(window.monaco && monaco.editor){ monaco.editor.setTheme(theme === 'light' ? 'vs' : 'vs-dark'); } }catch(_){ }
      }catch(e){ console.warn('applyTheme error', e); }
    }

    // determine initial theme
    let savedTheme = localStorage.getItem(THEME_KEY);
    if(!savedTheme){
      savedTheme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
    }
    // apply initial theme (Monaco will be updated again after load)
    applyTheme(savedTheme);

    if(themeToggleBtn){
      themeToggleBtn.addEventListener('click', ()=>{
        const current = document.body.classList.contains('light') ? 'light' : 'dark';
        const next = current === 'light' ? 'dark' : 'light';
        applyTheme(next);
      });
    }

    // Editor state & autosave
    let editor; // monaco editor instance
    let models = {}; // {html: model, css: model, js: model}
    let activeTab = 'html';
    let currentLoadedProjectId = null; // id of loaded project
    let autosaveTimer = null;
    const AUTOSAVE_IDLE_MS = 3000; // 3s idle
    let autoSaveEnabled = true;

    // Default sample
    const SAMPLE = {
      name: 'Sample Page',
      html: '<h1>Hello from KrizCode</h1>\n<p>Edit the HTML, CSS and JS tabs.</p>',
      css: 'body{font-family:Inter,Arial,sans-serif;padding:20px;background:#f7fbff}h1{color:#0078d4}',
      js: 'console.log("Hello KrizCode");'
    };

    // ---- Monaco Init ----
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' }});
    require(['vs/editor/editor.main'], function() {

      // Create models
      models.html = monaco.editor.createModel(SAMPLE.html, 'html');
      models.css = monaco.editor.createModel(SAMPLE.css, 'css');
      models.js  = monaco.editor.createModel(SAMPLE.js, 'javascript');

      // ---- KrizVibe AI Logic ----
      function toggleAIPanel() {
        aiBar.classList.toggle("expanded");
      }

      function addAIMessage(role, text) {
        const messageEl = document.createElement("div");
        messageEl.classList.add("ai-message", role);
        const roleEl = document.createElement("span");
        roleEl.className = "role";
        roleEl.textContent = role.toUpperCase();
        
        const textEl = document.createElement("div");
        // For assistant, wrap in PRE for code formatting.
        if (role === "assistant") {
            const preEl = document.createElement("pre");
            preEl.textContent = text;
            textEl.appendChild(preEl);
        } else {
            textEl.textContent = text;
        }

        messageEl.appendChild(roleEl);
        messageEl.appendChild(textEl);
        aiChat.appendChild(messageEl);
        // Scroll to bottom
        aiChat.scrollTop = aiChat.scrollHeight;
      }

      async function sendToAI(message) {
        if (!message.trim()) return;
        addAIMessage("user", message);
        aiInput.value = "";
        aiInput.disabled = true;
        aiSend.disabled = true;
        addAIMessage("assistant", "Generating code...");

        const systemPrompt = "You are KrizVibe AI, a professional website-generation assistant. You ALWAYS return output in exactly three sections using this format:\n\n[HTML]\nhtml code only\n\n[CSS]\ncss code only\n\n[JS]\njavascript code only\n\nNever include explanations. Never include comments unless they are inside code. Never wrap output inside backticks. Treat every user message as a request to generate or modify a website.";
        
        try {
          const response = await fetch("https://text.pollinations.ai/openai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              "model": "openai",
              "temperature": 1.0,
              "max_tokens": 1500,
              "messages": [
                 { "role": "system", "content": systemPrompt },
                 { "role": "user",   "content": message }
              ]
            })
          });

          if (!response.ok) {
            throw new Error("API request failed with status: " + response.status);
          }

          const data = await response.json();
          const reply = data.choices[0].message.content;

          // remove "Generating..." message
          aiChat.removeChild(aiChat.lastChild);
          addAIMessage("assistant", reply);

          const htmlMatch = reply.match(/\[HTML\]([\s\S]*?)\[CSS\]/);
          const cssMatch  = reply.match(/\[CSS\]([\s\S]*?)\[JS\]/);
          const jsMatch   = reply.match(/\[JS\]([\s\S]*)$/);

          const htmlCode = htmlMatch ? htmlMatch[1].trim() : "";
          const cssCode  = cssMatch ? cssMatch[1].trim() : "";
          const jsCode   = jsMatch ? jsMatch[1].trim() : "";

          if (htmlMatch) models.html.setValue(htmlCode);
          if (cssMatch) models.css.setValue(cssCode);
          if (jsMatch) models.js.setValue(jsCode);
          
          updatePreview();

        } catch (error) {
          aiChat.removeChild(aiChat.lastChild);
          addAIMessage("assistant", "Sorry, an error occurred: " + error.message);
          console.error("AI Error:", error);
        } finally {
          aiInput.disabled = false;
          aiSend.disabled = false;
          aiInput.focus();
        }
      }
      
      aiHeader.addEventListener("click", toggleAIPanel);
      aiSend.addEventListener("click", () => sendToAI(aiInput.value));
      aiInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendToAI(aiInput.value);
        }
      });
      // End KrizVibe AI Logic

      // Create the single editor and attach default model (html)
      editor = monaco.editor.create(editorContainer, {
        model: models.html,
        theme: 'vs-dark',
        automaticLayout: true,
        fontFamily: 'Consolas, "Courier New", monospace',
        fontSize: 13,
        minimap: { enabled: false },
        scrollbar: { verticalScrollbarSize: 10, horizontalScrollbarSize: 10 }
      });

      // Ensure Monaco matches selected theme (applyTheme will attempt to set it too)
      try{ if(typeof savedTheme !== 'undefined') applyTheme(savedTheme); }catch(_){ }

      // Tab switching logic (switch model)
      tabs.forEach(t => {
        t.addEventListener('click', () => {
          const tabName = t.dataset.tab;
          activateTab(tabName);
        });
      });

      function activateTab(name){
        activeTab = name;
        tabs.forEach(tb => tb.classList.toggle('active', tb.dataset.tab === name));
        editor.setModel(models[name]);
        editor.focus();
      }

      // Editor change handlers -> update preview & autosave timer
      function scheduleAutoSave(){
        autosaveStatus.textContent = 'pending...';
        if(autosaveTimer) clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(()=> {
          autosaveStatus.textContent = 'saving…';
          performAutoSave();
        }, AUTOSAVE_IDLE_MS);
      }

      editor.onDidChangeModelContent(() => {
        updatePreviewDebounced();
        scheduleAutoSave();
      });

      // also listen to model changes on all models (since setModel won't trigger)
      Object.values(models).forEach(m => {
        m.onDidChangeContent(() => {
          updatePreviewDebounced();
          scheduleAutoSave();
        });
      });

      // ---- Preview update ----
      let previewTimer = null;
      function updatePreviewDebounced(){
        if(previewTimer) clearTimeout(previewTimer);
        previewTimer = setTimeout(updatePreview, 200);
      }

      function getCombinedHTML(){
        const html = models.html.getValue();
        const css = models.css.getValue();
        const js  = models.js.getValue();
        return `<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>${css}</style>
</head>
<body>
${html}
<script>
${js}
<\/script>
</body>
</html>`;
      }

      function updatePreview(){
        const content = getCombinedHTML();
        previewFrame.srcdoc = content;
        previewUpdated.textContent = 'Last update: ' + new Date().toLocaleTimeString();
      }

      // Run on load
      updatePreview();

      // small helpers for safety and accessibility
      let lastActiveElement = null;
      function sanitizeFilename(name){
        // replace invalid filesystem chars, trim and limit length
        if(!name) return '';
        return name.replace(/[\\\/\:\*\?"<>\|]+/g, '-').trim().slice(0, 200);
      }

      function setSideOpen(open){
        sidePanel.classList.toggle('open', !!open);
        sidePanel.setAttribute('aria-hidden', String(!open));
      }

      // ---- Autosave & Projects ----
      function performAutoSave(){
        try {
          const draft = {
            id: 'draft',
            name: 'Draft (local)',
            html: models.html.getValue(),
            css: models.css.getValue(),
            js: models.js.getValue(),
            updated: nowISO()
          };
          // store as a special draft project (id = draft)
          let projects = loadProjects();
          const draftIndex = projects.findIndex(p => p.id === 'draft');
          if(draftIndex >= 0) projects[draftIndex] = draft;
          else projects.unshift(draft);
          saveProjects(projects);
          renderProjects();
          autosaveStatus.textContent = 'saved';
          // If an actual project is currently loaded, update it too (auto-update)
          if(currentLoadedProjectId && currentLoadedProjectId !== 'draft'){
            updateLoadedProjectContent();
          }
        } catch(e){
          console.error('AutoSave failed', e);
          autosaveStatus.textContent = 'error';
        } finally {
          setTimeout(()=> autosaveStatus.textContent = 'on', 800);
        }
      }

      function updateLoadedProjectContent(){
        const projects = loadProjects();
        const idx = projects.findIndex(p => p.id === currentLoadedProjectId);
        if(idx >= 0){
          projects[idx].html = models.html.getValue();
          projects[idx].css = models.css.getValue();
          projects[idx].js  = models.js.getValue();
          projects[idx].updated = nowISO();
          saveProjects(projects);
          renderProjects();
        }
      }

      // Save As (explicit)
      saveAsBtn.addEventListener('click', ()=>{
        const name = (projectNameInput.value || '').trim();
        if(!name){
          alert('Please provide a project name in the input to save.');
          projectNameInput.focus();
          return;
        }
        const projects = loadProjects();
        const newProj = {
          id: 'p_' + Date.now(),
          name,
          html: models.html.getValue(),
          css: models.css.getValue(),
          js: models.js.getValue(),
          updated: nowISO()
        };
        projects.unshift(newProj); // newest first
        saveProjects(projects);
        currentLoadedProjectId = newProj.id;
        renderProjects();
        alert('Saved project: ' + name);
      });

      // Save (updates loaded project or acts like Save As)
      saveProjectBtn.addEventListener('click', ()=>{
        if(currentLoadedProjectId){
          if(currentLoadedProjectId === 'draft'){
            // convert draft to new project; require name
            const name = (projectNameInput.value || '').trim();
            if(!name){ alert('Enter a project name to save draft as a project.'); projectNameInput.focus(); return; }
            const projects = loadProjects().filter(p => p.id !== 'draft');
            const newProj = {
              id: 'p_' + Date.now(),
              name,
              html: models.html.getValue(),
              css: models.css.getValue(),
              js: models.js.getValue(),
              updated: nowISO()
            };
            projects.unshift(newProj);
            saveProjects(projects);
            currentLoadedProjectId = newProj.id;
            renderProjects();
            alert('Draft saved as project: ' + name);
          } else {
            updateLoadedProjectContent();
            alert('Project updated.');
          }
        } else {
          // no loaded project -> Save As
          saveAsBtn.click();
        }
      });

      newProjectBtn.addEventListener('click', ()=>{
        const confirmNew = confirm('Create a fresh new project? Unsaved changes will be kept as draft.');
        if(!confirmNew) return;
        // reset models to blank
        models.html.setValue('<!-- New Project HTML -->\n');
        models.css.setValue('/* New Project CSS */\n');
        models.js.setValue('// New Project JS\n');
        currentLoadedProjectId = null;
        projectNameInput.value = '';
        updatePreview();
      });

      // Import sample
      importSampleBtn.addEventListener('click', ()=>{
        models.html.setValue(SAMPLE.html);
        models.css.setValue(SAMPLE.css);
        models.js.setValue(SAMPLE.js);
        projectNameInput.value = SAMPLE.name;
        currentLoadedProjectId = null;
        updatePreview();
      });

      // Clear drafts (remove any project with id 'draft')
      clearDraftsBtn.addEventListener('click', ()=>{
        const projects = loadProjects().filter(p => p.id !== 'draft');
        saveProjects(projects);
        renderProjects();
      });

      // Projects UI render
      function renderProjects(){
        const projects = loadProjects();
        projListEl.innerHTML = '';
        if(projects.length === 0){
          projListEl.innerHTML = '<div class="muted">No projects yet. Use "Save As" to create one.</div>';
          return;
        }
        projects.forEach(p => {
          const item = document.createElement('div');
          item.className = 'proj-item';
          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.flexDirection = 'column';
          const title = document.createElement('strong');
          title.textContent = p.name + (p.id === 'draft' ? ' (Draft)' : '');
          const meta = document.createElement('span');
          meta.className = 'meta muted';
          meta.textContent = 'Updated: ' + new Date(p.updated).toLocaleString();
          left.appendChild(title);
          left.appendChild(meta);

          const actions = document.createElement('div');
          actions.className = 'proj-actions';
          const loadBtn = document.createElement('button');
          loadBtn.className = 'icon-btn';
          loadBtn.innerHTML = '<i class="fa-solid fa-folder-open"></i>';
          loadBtn.title = 'Load project';
          loadBtn.addEventListener('click', ()=> loadProject(p.id));

          const updateBtn = document.createElement('button');
          updateBtn.className = 'icon-btn';
          updateBtn.innerHTML = '<i class="fa-solid fa-upload"></i>';
          updateBtn.title = 'Update this project with current editor content';
          updateBtn.addEventListener('click', ()=> {
            if(confirm('Replace project "'+p.name+'" content with current editor content?')){
              p.html = models.html.getValue();
              p.css = models.css.getValue();
              p.js = models.js.getValue();
              p.updated = nowISO();
              const arr = loadProjects().map(x => x.id === p.id ? p : x);
              saveProjects(arr);
              renderProjects();
              alert('Project updated.');
            }
          });

          const delBtn = document.createElement('button');
          delBtn.className = 'icon-btn';
          delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
          delBtn.title = 'Delete project';
          delBtn.addEventListener('click', ()=>{
            if(confirm('Delete "'+p.name+'" permanently?')) {
              const arr = loadProjects().filter(x => x.id !== p.id);
              saveProjects(arr);
              if(currentLoadedProjectId === p.id) currentLoadedProjectId = null;
              renderProjects();
            }
          });

          actions.appendChild(loadBtn);
          actions.appendChild(updateBtn);
          actions.appendChild(delBtn);

          item.appendChild(left);
          item.appendChild(actions);
          projListEl.appendChild(item);
        });
      }

      function loadProject(id){
        const projects = loadProjects();
        const p = projects.find(x => x.id === id);
        if(!p) return alert('Project not found');
        models.html.setValue(p.html || '');
        models.css.setValue(p.css || '');
        models.js.setValue(p.js || '');
        projectNameInput.value = p.name || '';
        currentLoadedProjectId = p.id;
        updatePreview();
        alert('Loaded project: ' + p.name);
      }

  // render existing on load
  renderProjects();

  // toggle side (use accessible toggle helper)
  toggleSideBtn.addEventListener('click', ()=> setSideOpen(!sidePanel.classList.contains('open')));
  closeSideBtn.addEventListener('click', ()=> setSideOpen(false));

      // ---- Download logic (mandatory filename) ----
      downloadBtn.addEventListener('click', ()=>{
        // require filename in visible input; open modal if empty
        const fname = (filenameInput.value || '').trim();
        if(!fname){
          lastActiveElement = document.activeElement;
          modalBackdrop.classList.add('show');
          modalFilename.value = '';
          setTimeout(()=> modalFilename.focus(), 10);
          return;
        }
        triggerDownload(fname);
      });

      modalCancel.addEventListener('click', ()=>{
        modalBackdrop.classList.remove('show');
        try{ if(lastActiveElement) lastActiveElement.focus(); } catch(e){}
      });
      modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop){ modalBackdrop.classList.remove('show'); try{ if(lastActiveElement) lastActiveElement.focus(); }catch(_){}} });

      modalDownload.addEventListener('click', ()=>{
        const raw = (modalFilename.value || '').trim();
        const fname = sanitizeFilename(raw);
        if(!fname){ alert('Enter a valid filename'); setTimeout(()=> modalFilename.focus(), 10); return; }
        filenameInput.value = fname;
        modalBackdrop.classList.remove('show');
        triggerDownload(fname);
        try{ if(lastActiveElement) lastActiveElement.focus(); } catch(e){}
      });

      function triggerDownload(name){
        const safe = sanitizeFilename(name || 'download');
        if(!safe){ alert('Invalid filename'); return; }
        const outName = safe.endsWith('.html') ? safe : (safe + '.html');
        const content = getCombinedHTML();
        const blob = new Blob([content], {type: 'text/html;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = outName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // Open in new tab (no filename required)
      openNewTab.addEventListener('click', ()=>{
        const w = window.open();
        if(!w){ alert('Unable to open a new tab. It may be blocked by the browser.'); return; }
        w.document.open();
        w.document.write(getCombinedHTML());
        w.document.close();
      });

      // Run button
      runBtn.addEventListener('click', updatePreview);

      // Keyboard: Ctrl/Cmd+S to save project (Save As flow if no loaded project)
      window.addEventListener('keydown', (e)=>{
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
          e.preventDefault();
          saveProjectBtn.click();
        }
      });

      // initial autosave status
      autosaveStatus.textContent = 'on';

      // About page toggle behavior
      function showAbout(show){
        const containerEl = document.querySelector('.container');
        if(show){
          // hide editor UI
          try{ containerEl.style.display = 'none'; }catch(_){}
          try{ sidePanel.classList.remove('open'); sidePanel.style.display = 'none'; }catch(_){}
          aboutSectionEl.style.display = 'block';
          aboutBtn.classList.add('active');
          aboutBtn.innerHTML = '<i class="fa-solid fa-arrow-left"></i> Back';
        } else {
          aboutSectionEl.style.display = 'none';
          try{ containerEl.style.display = ''; }catch(_){}
          try{ sidePanel.style.display = ''; }catch(_){}
          aboutBtn.classList.remove('active');
          aboutBtn.innerHTML = '<i class="fa-solid fa-circle-info"></i> About';
          // Re-layout Monaco after showing editor again
          setTimeout(()=>{ try{ if(window.editor && typeof editor.layout === 'function') editor.layout(); }catch(_){ } }, 80);
        }
      }

      if(aboutBtn){
        aboutBtn.addEventListener('click', ()=>{
          const isShowing = aboutSectionEl && aboutSectionEl.style.display !== 'none';
          showAbout(!isShowing);
        });
      }
    }); // end require

    // ---- Utility: initial projects seed if empty? keep minimal ----
    // ensure storage exists
    if(!localStorage.getItem('krizcode_projects_v1')){
      saveProjects([{
        id: 'draft',
        name: 'Draft (local)',
        html: SAMPLE.html,
        css: SAMPLE.css,
        js: SAMPLE.js,
        updated: nowISO()
      }]);
    }

    setTimeout(()=> {
      const evt = new Event('kriz_render_projects');
      window.dispatchEvent(evt);
    }, 300);

    window.addEventListener('kriz_render_projects', ()=>{
      // This event exists so the file can trigger any external plugin hooks if needed.
    });

  })();
  </script>
</body>
</html>
